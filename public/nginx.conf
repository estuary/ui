# This config file was taken from the default nginx image by running:
# $ docker run --rm --detach --name tmp nginx:alpine
# $ docker cp tmp:/etc/nginx/nginx.conf
# Any modifications from the default should have comments.
user  nginx;
worker_processes  auto;

set $linkedInConnectDomains "https://px.ads.linkedin.com";

set $estuaryConnectDomains "https://*.estuary-data.com https://*.estuary-data.dev https://config-encryption.estuary.dev https://eyrcnmuzzyriypdajwdk.supabase.co https://agent-api-1084703453822.us-central1.run.app https://gcp-marketplace-verify-mo7rswd2xq-uc.a.run.app";

set $stripeConnectDomains "https://api.stripe.com https://maps.googleapis.com";

set $logRocketConnectDomains "https://*.logrocket.io https://*.lr-ingest.io https://*.logrocket.com https://*.lr-in.com https://*.lr-in-prod.com https://*.lr-ingest.com https://*.ingest-lr.com https://*.lr-intake.com https://*.intake-lr.com https://*.logr-ingest.com https://*.lrkt-in.com";

set $googleConnectDomains "https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com https://*.g.doubleclick.net https://*.google.com https://*.google.ad https://*.google.ae https://*.google.com.af https://*.google.com.ag https://*.google.al https://*.google.am https://*.google.co.ao https://*.google.com.ar https://*.google.as https://*.google.at https://*.google.com.au https://*.google.az https://*.google.ba https://*.google.com.bd https://*.google.be https://*.google.bf https://*.google.bg https://*.google.com.bh https://*.google.bi https://*.google.bj https://*.google.com.bn https://*.google.com.bo https://*.google.com.br https://*.google.bs https://*.google.bt https://*.google.co.bw https://*.google.by https://*.google.com.bz https://*.google.ca https://*.google.cd https://*.google.cf https://*.google.cg https://*.google.ch https://*.google.ci https://*.google.co.ck https://*.google.cl https://*.google.cm https://*.google.cn https://*.google.com.co https://*.google.co.cr https://*.google.com.cu https://*.google.cv https://*.google.com.cy https://*.google.cz https://*.google.de https://*.google.dj https://*.google.dk https://*.google.dm https://*.google.com.do https://*.google.dz https://*.google.com.ec https://*.google.ee https://*.google.com.eg https://*.google.es https://*.google.com.et https://*.google.fi https://*.google.com.fj https://*.google.fm https://*.google.fr https://*.google.ga https://*.google.ge https://*.google.gg https://*.google.com.gh https://*.google.com.gi https://*.google.gl https://*.google.gm https://*.google.gr https://*.google.com.gt https://*.google.gy https://*.google.com.hk https://*.google.hn https://*.google.hr https://*.google.ht https://*.google.hu https://*.google.co.id https://*.google.ie https://*.google.co.il https://*.google.im https://*.google.co.in https://*.google.iq https://*.google.is https://*.google.it https://*.google.je https://*.google.com.jm https://*.google.jo https://*.google.co.jp https://*.google.co.ke https://*.google.com.kh https://*.google.ki https://*.google.kg https://*.google.co.kr https://*.google.com.kw https://*.google.kz https://*.google.la https://*.google.com.lb https://*.google.li https://*.google.lk https://*.google.co.ls https://*.google.lt https://*.google.lu https://*.google.lv https://*.google.com.ly https://*.google.co.ma https://*.google.md https://*.google.me https://*.google.mg https://*.google.mk https://*.google.ml https://*.google.com.mm https://*.google.mn https://*.google.com.mt https://*.google.mu https://*.google.mv https://*.google.mw https://*.google.com.mx https://*.google.com.my https://*.google.co.mz https://*.google.com.na https://*.google.com.ng https://*.google.com.ni https://*.google.ne https://*.google.nl https://*.google.no https://*.google.com.np https://*.google.nr https://*.google.nu https://*.google.co.nz https://*.google.com.om https://*.google.com.pa https://*.google.com.pe https://*.google.com.pg https://*.google.com.ph https://*.google.com.pk https://*.google.pl https://*.google.pn https://*.google.com.pr https://*.google.ps https://*.google.pt https://*.google.com.py https://*.google.com.qa https://*.google.ro https://*.google.ru https://*.google.rw https://*.google.com.sa https://*.google.com.sb https://*.google.sc https://*.google.se https://*.google.com.sg https://*.google.sh https://*.google.si https://*.google.sk https://*.google.com.sl https://*.google.sn https://*.google.so https://*.google.sm https://*.google.sr https://*.google.st https://*.google.com.sv https://*.google.td https://*.google.tg https://*.google.co.th https://*.google.com.tj https://*.google.tl https://*.google.tm https://*.google.tn https://*.google.to https://*.google.com.tr https://*.google.tt https://*.google.com.tw https://*.google.co.tz https://*.google.com.ua https://*.google.co.ug https://*.google.co.uk https://*.google.com.uy https://*.google.co.uz https://*.google.com.vc https://*.google.co.ve https://*.google.co.vi https://*.google.com.vn https://*.google.vu https://*.google.ws https://*.google.rs https://*.google.co.za https://*.google.co.zm https://*.google.co.zw https://*.google.cat";

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    # X-Frame-Options is to prevent from clickJacking attack
    add_header X-Frame-Options SAMEORIGIN;

    # disable content-type sniffing on some browsers.
    add_header X-Content-Type-Options nosniff;

    # Enable gzip
    gzip on;
    gzip_min_length  500;
    gzip_proxied     any;
    gzip_comp_level 4;
    gzip_types  text/css text/javascript text/xml text/plain text/x-component application/javascript application/json application/wasm application/xml font/truetype font/opentype font/woff2 image/svg+xml;
    gzip_vary on;
    gzip_disable     "msie6";

    # This configuration was added so that users refreshing the page will not get a 404 due to the
    # react router URLs (e.g. `/captures/create`) not corresponding to an actual resource on the
    # server. The `try_files` will ensure that we serve index.html if the requested resource is not
    # found. This was adapted from /etc/nginx/conf.d/default.conf, which was previously brought in
    # with an `include` directive.
    server {
        listen       80;
        listen  [::]:80;
        server_name  localhost;

        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;

            # just use the request id for right now
            # need to generate a true one
            set $cspNonce $request_id;
            
            # Put the nonce into the html response
            sub_filter_once off;
            sub_filter_types *;
            sub_filter __NGINX_CSP_NONCE__ $cspNonce;

            add_header Cache-Control 'no-cache, no-store, must-revalidate';
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
            add_header X-Frame-Options SAMEORIGIN always;
            add_header X-Content-Type-Options nosniff always;
            add_header Referrer-Policy no-referrer-when-downgrade always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=() always";
            add_header Cross-Origin-Opener-Policy same-origin-allow-popups always;

            # CSP docs (do NOT trust 100% as sometimes they are outdated)
            # Google - https://developers.google.com/tag-platform/security/guides/csp
            # Log Rocket - https://docs.logrocket.com/docs/troubleshooting-sessions#due-to-content-security-policy
            # Stripe - https://docs.stripe.com/security/guide#content-security-policy
            # BE CAREFUL WHEN EDITING
            #   This is all pretty brittle 
            #   Most things are on a single line because adding new lines broke it in prod somehow
            add_header Content-Security-Policy "
                default-src 'self';
                connect-src 'self' $linkedInConnectDomains $estuaryConnectDomains $stripeConnectDomains $logRocketConnectDomains $googleConnectDomains;
                frame-src 'self' https://docs.estuary.dev https://go.estuary.dev https://connect-js.stripe.com https://js.stripe.com https://*.js.stripe.com https://hooks.stripe.com https://td.doubleclick.net https://www.googletagmanager.com;
                script-src 'self' 'unsafe-eval' 'nonce-$cspNonce' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com https://*.g.doubleclick.net https://*.google.com https://*.reo.dev https://*.stripe.network https://*.js.stripe.com https://js.stripe.com https://maps.googleapis.com https://cdn.logrocket.io https://cdn.lr-ingest.io https://cdn.lr-in.com https://cdn.lr-in-prod.com https://cdn.lr-ingest.com https://cdn.ingest-lr.com https://cdn.lr-intake.com https://cdn.intake-lr.com https://*.logr-ingest.com https://snap.licdn.com;
                base-uri 'self';
                child-src 'self' blob:;
                font-src 'self' data: https:;
                form-action 'self';
                frame-ancestors 'self';
                img-src 'self' data: https:;
                manifest-src 'self';
                media-src 'self';
                object-src 'none';
                style-src 'self' 'unsafe-inline';
                worker-src 'self' blob:;
                reflected-xss 'block';
                upgrade-insecure-requests;
            ";

            # used to test new csp settings
            add_header Content-Security-Policy-Report-Only "
                require-trusted-types-for 'script';
                report-uri https://67211c41d5ccea405a7a6cd5.endpoint.csper.io/?v=0;
            ";

            # Here to serve our T&C doc
            location /terms.html {
                root   /usr/share/nginx/html;
                index  terms.html;
                try_files $uri $uri/ /terms.html;
            }

            # Serves json file used for UI to figure out latest build
            location /meta.json {
                root   /usr/share/nginx/html;
                index  meta.json;
                try_files $uri $uri/ /meta.json;
            }
        }

        # Server up the JS/images/etc. from UI build
        location /static/ {
            alias   /usr/share/nginx/html/static/;
            expires 1y;
            add_header Cache-Control "public";
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }

        if (-f /usr/share/nginx/html/maintenance) {
            return 503;
        }
        error_page 503 @maintenance;

        location @maintenance {
            root /usr/share/nginx/html;
            rewrite ^(.*)$ /503.html break;
        }
    }
}

